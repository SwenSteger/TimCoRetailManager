@using TRMBlazor.WebAssembly.Pages
@inject IApiHelper ApiHelper
@inject ILoggedInUserModel LoggedInUserModel
@inject ILocalStorageService LocalStorage
@inject NavigationManager NavigationManager

<nav class="navbar navbar-expand-lg navbar-dark bg-header">
	<div class="container-lg">
		<div class="branding">
			<NavLink class="navbar-brand" href="" Match="NavLinkMatch.All">
				<span class="brand-img">
					<img src="/favicon.png" alt="Portfolio" class="img-fluid mr-2">
				</span>
				<span class="brand-title">TimCo RM</span>
			</NavLink>
		</div>

		@if (IsAuthenticated)
		{
			<ul class="navbar-nav me-auto">
				<li class="nav-item">
					<NavLink class="nav-link" href="" Match="NavLinkMatch.All">
						<span class="oi oi-home" aria-hidden="true"></span> Home
					</NavLink>
				</li>
				<li class="nav-item">
					<NavLink class="nav-link" href="/sales" Match="NavLinkMatch.Prefix">
						<span class="oi oi-cart" aria-hidden="true"></span> Sales
					</NavLink>
				</li>
			</ul>
			<div class="float-end welcome_user">
				<Authorized>
					<span>Welcome, @Username</span>
					<button class="btn btn-danger my-2 my-sm-0" @onclick="HandleLogout">Logout</button>
				</Authorized>
			</div>
		}
		else
		{
			<div class="float-end welcome_user">
				<a href="/login" class="btn btn-outline-danger my-2 my-sm-0">Login</a>
				<a href="/register" class="btn btn-outline-success my-2 my-sm-0">Register</a>
			</div>
		}
	</div>
</nav>



@code {
	private string Username { get; set; } = "user";
	private bool IsAuthenticated => LoggedInUserModel != null;

    protected override async Task OnInitializedAsync()
    {
	    await ValidateToken();
    }

	private async Task ValidateToken()
	{
		var token = await LocalStorage.GetItemAsync<string>("authToken");
		if (token != null)
		{
			await ApiHelper.GetLoggedInUserInfo(token);
			Username = LoggedInUserModel.FirstName;
		}
	}

    private async Task HandleLogout()
    {
	    await LocalStorage.RemoveItemAsync("authToken");
	    LoggedInUserModel = null;
	    NavigationManager.NavigateTo("/login");
    }
}